<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Página ESP32</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <h1 class="titulo">Projeto ESP32 - Temperatura e Umidade</h1>
  </header>

  <main>
    <h2>Projeto proposto pelo professor Paulo. ESP32 com o sensor DHT22 mostrando em tempo real temperatura e umidade.
    </h2>
    <h3>Ver temperatura e umidade em tempo real</h3>

    <div id="dados">
      <p>Temperatura: <span id="temperatura">--</span> °C</p>
      <p>Umidade: <span id="umidade">--</span> %</p>
    </div>
    <canvas id="grafico-tempo-real" width="940" height="360"
      style="width:100%;max-width:960px;border:1px solid #e5e5e5;background:#fff;border-radius:12px;margin-top:8px"></canvas>


  </main>

  <footer>
    <img src="assets/LogoUema.png" alt="LOGO_UEMA" class="imagem">
    <p class = "rodape">
      Universidade Estadual do Maranhão<br>
      Curso de Engenharia de Computação
    </p>
  </footer>

  <script>
    async function leituraAtual() {
      try {
        const r = await fetch('/api/leitura', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const { temperatura, umidade } = await r.json();

        document.getElementById('temperatura').textContent =
          (typeof temperatura === 'number') ? temperatura.toFixed(1) : '--';
        document.getElementById('umidade').textContent =
          (typeof umidade === 'number') ? umidade.toFixed(1) : '--';
      } catch (e) {
        console.log(e);
      }
    }
    leituraAtual();
    setInterval(leituraAtual, 1000);
  </script>

<script>
  // ===== Gráfico em JS puro (sem bibliotecas) =====
  // Configurações do gráfico
  const graf_MAX_PONTOS = 60;                          // histórico (≈2 min se ler a cada 2s)
  const graf_MARGENS    = { esquerda:45, direita:15, topo:15, base:25 };

  // Séries de dados em memória
  const graf_temperaturas = [];                        // números (°C)
  const graf_umidades     = [];                        // números (%)

    // Alvos de desenho
    const graf_canvas = document.getElementById('grafico-tempo-real');
    const graf_ctx = graf_canvas.getContext('2d');

  // --- Conversão índice → X (mantemos igual) ---
  function graf_indiceParaX(indice, total, largura) {
    if (total <= 1) return graf_MARGENS.esquerda;
    const areaLargura = largura - graf_MARGENS.esquerda - graf_MARGENS.direita;
    return graf_MARGENS.esquerda + areaLargura * (indice / (total - 1));
  }

  // --- Desenho do gráfico (normalizado 0..100%) ---
  function graf_desenhar() {
    const W = graf_canvas.width, H = graf_canvas.height;
    graf_ctx.clearRect(0, 0, W, H);

    const n = Math.max(graf_temperaturas.length, graf_umidades.length);
    if (n === 0) return;

    // Área útil vertical e helper para mapear fração [0..1] → Y em pixels
    const areaAltura = H - graf_MARGENS.topo - graf_MARGENS.base;
    function yFromFrac(frac) { // frac=0 → base; frac=1 → topo
      return graf_MARGENS.topo + areaAltura * (1 - frac);
    }

    // Eixos
    graf_ctx.strokeStyle = '#cccccc';
    graf_ctx.lineWidth   = 1;
    graf_ctx.beginPath();
    // X
    graf_ctx.moveTo(graf_MARGENS.esquerda, H - graf_MARGENS.base);
    graf_ctx.lineTo(W - graf_MARGENS.direita, H - graf_MARGENS.base);
    // Y
    graf_ctx.moveTo(graf_MARGENS.esquerda, graf_MARGENS.topo);
    graf_ctx.lineTo(graf_MARGENS.esquerda, H - graf_MARGENS.base);
    graf_ctx.stroke();

    // Grade + rótulos (0%, 20%, 40%, 60%, 80%, 100%)
    graf_ctx.font = '12px system-ui, Arial, sans-serif';
    graf_ctx.fillStyle = '#666';
    for (let j = 0; j <= 5; j++) {
      const frac = j / 5;                 // 0..1
      const y    = yFromFrac(frac);
      graf_ctx.strokeStyle = '#efefef';
      graf_ctx.beginPath();
      graf_ctx.moveTo(graf_MARGENS.esquerda, y);
      graf_ctx.lineTo(W - graf_MARGENS.direita, y);
      graf_ctx.stroke();
      graf_ctx.fillText(String((frac * 100).toFixed(0)) + '%', 4, y + 4);
    }

    // Desenha uma série normalizando para 0..1 (depois vira 0..100% na escala comum)
    function desenharSerieNormalizada(arr, cor) {
      if (arr.length === 0) return;
      let smin = Math.min(...arr);
      let smax = Math.max(...arr);
      if (smax === smin) smax = smin + 1; // evita divisão por zero

      graf_ctx.strokeStyle = cor;
      graf_ctx.lineWidth   = 2;
      graf_ctx.lineJoin    = 'round';
      graf_ctx.lineCap     = 'round';
      graf_ctx.beginPath();

      arr.forEach((valor, i) => {
        const x = graf_indiceParaX(i, arr.length, W);
        const frac = (valor - smin) / (smax - smin); // 0..1 da própria série
        const y = yFromFrac(frac);
        if (i === 0) graf_ctx.moveTo(x, y); else graf_ctx.lineTo(x, y);
      });

      graf_ctx.stroke();
    }

    // Agora ambas ficam na mesma escala vertical (0..100%)
    desenharSerieNormalizada(graf_temperaturas, '#e53935'); // vermelho
    desenharSerieNormalizada(graf_umidades,     '#1e88e5'); // azul
  }

  // --- Captura números dos <span> e atualiza as séries ---
  function graf_capturarDosSpans() {
    const elT = document.getElementById('temperatura');
    const elU = document.getElementById('umidade');
    if (!elT || !elU) return;

    const T = parseFloat(String(elT.textContent).replace(',', '.'));
    const U = parseFloat(String(elU.textContent).replace(',', '.'));
    if (!Number.isFinite(T) || !Number.isFinite(U)) return;

    graf_temperaturas.push(T);
    graf_umidades.push(U);
    if (graf_temperaturas.length > graf_MAX_PONTOS) graf_temperaturas.shift();
    if (graf_umidades.length     > graf_MAX_PONTOS) graf_umidades.shift();

      // Grade e rótulos Y
      graf_ctx.font = '12px system-ui, Arial, sans-serif';
      graf_ctx.fillStyle = '#666';
      for (let j = 0; j <= 5; j++) {
        const frac = j / 5;
        const yVal = vmin + (vmax - vmin) * (1 - frac);
        const y = graf_valorParaY(yVal, vmin, vmax, H);
        graf_ctx.strokeStyle = '#efefef';
        graf_ctx.beginPath();
        graf_ctx.moveTo(graf_MARGENS.esquerda, y);
        graf_ctx.lineTo(W - graf_MARGENS.direita, y);
        graf_ctx.stroke();
        graf_ctx.fillText(yVal.toFixed(0), 4, y + 4);
      }

      // Função para desenhar uma série (temperatura/umidade)
      function desenharSerie(arr, cor) {
        if (arr.length === 0) return;
        graf_ctx.strokeStyle = cor;
        graf_ctx.lineWidth = 2;
        graf_ctx.beginPath();
        arr.forEach((valor, i) => {
          const x = graf_indiceParaX(i, arr.length, W);
          const y = graf_valorParaY(valor, vmin, vmax, H);
          if (i === 0) graf_ctx.moveTo(x, y); else graf_ctx.lineTo(x, y);
        });
        graf_ctx.stroke();
      }

      desenharSerie(graf_temperaturas, '#e53935'); // vermelho
      desenharSerie(graf_umidades, '#1e88e5'); // azul
    }

    // --- Captura os números dos <span> e atualiza as séries ---
    function graf_capturarDosSpans() {
      const elT = document.getElementById('temperatura');
      const elU = document.getElementById('umidade');
      if (!elT || !elU) return;

      // Pega o texto, troca vírgula por ponto e converte para número
      const T = parseFloat(String(elT.textContent).replace(',', '.'));
      const U = parseFloat(String(elU.textContent).replace(',', '.'));
      if (!Number.isFinite(T) || !Number.isFinite(U)) return; // ignora enquanto for "--"

      // Empilha e respeita o limite de pontos (janela deslizante)
      graf_temperaturas.push(T);
      graf_umidades.push(U);
      if (graf_temperaturas.length > graf_MAX_PONTOS) graf_temperaturas.shift();
      if (graf_umidades.length > graf_MAX_PONTOS) graf_umidades.shift();

      graf_desenhar();
    }

    // Sincroniza com seu setInterval(leituraAtual, 2000)
    graf_capturarDosSpans();               // tenta desenhar uma vez no início
    setInterval(graf_capturarDosSpans, 2000);

    // Redesenha se o canvas mudar de tamanho visual (ex.: orientação/resize)
    addEventListener('resize', graf_desenhar);
  </script>

</body>

</html>