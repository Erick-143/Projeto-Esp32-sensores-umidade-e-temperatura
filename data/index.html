<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Página ESP32</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <h1 class="titulo">Projeto ESP32 - Temperatura e Umidade</h1>
  </header>

  <main>
    <h2>Projeto proposto pelo professor Paulo. ESP32 com o sensor DHT22 mostrando em tempo real temperatura e umidade.
    </h2>
    <h3>Ver temperatura e umidade em tempo real</h3>

    <div id="dados">
      <p>Temperatura(vermelho): <span id="temperatura">--</span> °C</p>
      <p>Umidade(azul): <span id="umidade">--</span> %</p>
    </div>
    <canvas id="grafico-tempo-real" width="940" height="360"
      style="width:100%;max-width:960px;border:1px solid #e5e5e5;background:#fff;border-radius:12px;margin-top:8px"></canvas>


  </main>

  <footer>
    <img src="assets/LogoUema.png" alt="LOGO_UEMA" class="imagem">
    <p class = "rodape">
      Universidade Estadual do Maranhão<br>
      Curso de Engenharia de Computação
    </p>
  </footer>

  <script>
    async function leituraAtual() {
      try {
        const r = await fetch('/api/leitura', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const { temperatura, umidade } = await r.json();

        document.getElementById('temperatura').textContent =
          (typeof temperatura === 'number') ? temperatura.toFixed(1) : '--';
        document.getElementById('umidade').textContent =
          (typeof umidade === 'number') ? umidade.toFixed(1) : '--';
      } catch (e) {
        console.log(e);
      }
    }
    leituraAtual();
    setInterval(leituraAtual, 1000);
  </script>

<script>
  // ===== Gráfico comparativo 0..100 (min/max COMUNS) =====
  // Configurações
  const graf_MAX_PONTOS = 120;                         // ~2 min se ler a cada 1 s
  const graf_MARGENS    = { esquerda:45, direita:15, topo:15, base:25 };

  // Histórico
  const graf_temperaturas = [];
  const graf_umidades     = [];

  // Canvas
  const graf_canvas = document.getElementById('grafico-tempo-real');
  const graf_ctx    = graf_canvas.getContext('2d');

  // índice → X
  function graf_indiceParaX(indice, total, largura) {
    if (total <= 1) return graf_MARGENS.esquerda;
    const areaLargura = largura - graf_MARGENS.esquerda - graf_MARGENS.direita;
    return graf_MARGENS.esquerda + areaLargura * (indice / (total - 1));
  }

  // Desenho (escala comum 0..100)
  function graf_desenhar() {
    const W = graf_canvas.width, H = graf_canvas.height;
    graf_ctx.clearRect(0, 0, W, H);

    const n = Math.max(graf_temperaturas.length, graf_umidades.length);
    if (n === 0) return;

    // Min e max COMUNS às duas séries (janela atual)
    const todos = graf_temperaturas.concat(graf_umidades).filter(Number.isFinite);
    let vmin = Math.min(...todos);
    let vmax = Math.max(...todos);
    if (vmax === vmin) vmax = vmin + 1; // evita divisão por zero

    // Área útil e mapeamento fração [0..1] → Y
    const areaAltura = H - graf_MARGENS.topo - graf_MARGENS.base;
    const yFromFrac = (frac) => graf_MARGENS.topo + areaAltura * (1 - frac);

    // Eixos
    graf_ctx.strokeStyle = '#cccccc';
    graf_ctx.lineWidth   = 1;
    graf_ctx.beginPath();
    // X
    graf_ctx.moveTo(graf_MARGENS.esquerda, H - graf_MARGENS.base);
    graf_ctx.lineTo(W - graf_MARGENS.direita, H - graf_MARGENS.base);
    // Y
    graf_ctx.moveTo(graf_MARGENS.esquerda, graf_MARGENS.topo);
    graf_ctx.lineTo(graf_MARGENS.esquerda, H - graf_MARGENS.base);
    graf_ctx.stroke();

    // Grade + rótulos 0..100 (sem “%”)
    graf_ctx.font = '12px system-ui, Arial, sans-serif';
    graf_ctx.fillStyle = '#666';
    for (let j = 0; j <= 5; j++) {
      const frac = j / 5;                 // 0, 0.2, 0.4, 0.6, 0.8, 1
      const y    = yFromFrac(frac);
      graf_ctx.strokeStyle = '#efefef';
      graf_ctx.beginPath();
      graf_ctx.moveTo(graf_MARGENS.esquerda, y);
      graf_ctx.lineTo(W - graf_MARGENS.direita, y);
      graf_ctx.stroke();
      graf_ctx.fillText(String((frac * 100).toFixed(0)), 4, y + 4); // sem símbolo
    }

    // Desenha série mapeando valor real → [0..1] com base no vmin/vmax COMUNS
    function desenharSerieEscalaComum(arr, cor) {
      if (arr.length === 0) return;

      graf_ctx.strokeStyle = cor;
      graf_ctx.lineWidth   = 2;
      graf_ctx.lineJoin    = 'round';
      graf_ctx.lineCap     = 'round';
      graf_ctx.beginPath();

      arr.forEach((valor, i) => {
        const x = graf_indiceParaX(i, arr.length, W);
        const frac = (valor - vmin) / (vmax - vmin);     // 0..1 na escala COMUM
        const y = yFromFrac(frac);
        if (i === 0) graf_ctx.moveTo(x, y); else graf_ctx.lineTo(x, y);
      });

      graf_ctx.stroke();
    }

    // Ambas na mesma escala 0..100 (sem “%”)
    desenharSerieEscalaComum(graf_temperaturas, '#e53935'); // vermelho
    desenharSerieEscalaComum(graf_umidades,     '#1e88e5'); // azul
  }

  // Lê dos <span> e atualiza histórico
  function graf_capturarDosSpans() {
    const elT = document.getElementById('temperatura');
    const elU = document.getElementById('umidade');
    if (!elT || !elU) return;

    const T = parseFloat(String(elT.textContent).replace(',', '.'));
    const U = parseFloat(String(elU.textContent).replace(',', '.'));
    if (!Number.isFinite(T) || !Number.isFinite(U)) return;

    graf_temperaturas.push(T);
    graf_umidades.push(U);
    if (graf_temperaturas.length > graf_MAX_PONTOS) graf_temperaturas.shift();
    if (graf_umidades.length     > graf_MAX_PONTOS) graf_umidades.shift();

    graf_desenhar();
  }

  // Mesma cadência do seu leituraAtual (1 s)
  graf_capturarDosSpans();
  setInterval(graf_capturarDosSpans, 1000);

  // Redesenha no resize
  addEventListener('resize', graf_desenhar);
</script>


</body>

</html>